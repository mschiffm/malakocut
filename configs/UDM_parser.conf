filter {
  # 1. Parse JSON
  json {
    source => "message"
  }

  # 2. Timestamp
  date {
    match => ["timestamp", "ISO8601"]
    target => "event.idm.read_only_udm.metadata.event_timestamp"
  }

  # 3. Cast numeric fields to integers (Ports accept standard ints, bytes do not)
  mutate {
    convert => {
      "src_port" => "integer"
      "dst_port" => "integer"
    }
  }

  # 4. Hardcoded Metadata
  mutate {
    replace => {
      "event.idm.read_only_udm.metadata.event_type" => "NETWORK_CONNECTION"
      "event.idm.read_only_udm.metadata.vendor_name" => "Custom"
      "event.idm.read_only_udm.metadata.product_name" => "malakocut"
    }
  }

  # 5. RENAME: Safely moves scalar strings and our newly cast integer ports
  mutate {
    rename => {
      "flow_id"  => "event.idm.read_only_udm.network.session_id"
      "protocol" => "event.idm.read_only_udm.network.ip_protocol"
      "src_port" => "event.idm.read_only_udm.principal.port"
      "dst_port" => "event.idm.read_only_udm.target.port"
    }
  }

  # 6. MERGE: Coerces the IP strings into UDM arrays
  mutate {
    merge => {
      "event.idm.read_only_udm.principal.ip" => "src_ip"
      "event.idm.read_only_udm.target.ip"    => "dst_ip"
    }
  }

  # 7. Bind to Output Engine
  mutate {
    merge => { "@output" => "event" }
  }
}
